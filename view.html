<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Color Awareness Image View Test</title>

  <!-- Load the webgazer.js file from /static -->
  <script src="./static/webgazer.js"></script>
  <!-- Bootstrap for styling -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>

</head>

<body>

  <canvas id="mainImage"> </canvas>

  <a href="./">
    <button style="z-index: 2;" class="btn btn-outline-danger position-absolute">
      Exit
    </button>
  </a>
  <p style="margin-left: 350px;">The image/gif may take a few seconds to load!</p>
  <br>
  <p style="margin-left: 350px;" id="imageName"></p>

  <div class="modal fade" id="startModal">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Viewing An Image</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <b>Instructions</b>
          <br>
          <p>Observe the image, and the peripherals of the image will be desaturated. The exit button is in the top
            left.
            <br><br>
            To change the image: left/right arrow keys
            <br>
            To change the radius of saturation: up/down arrow keys to inc/dec radius
          </p>
        </div>
      </div>
    </div>
  </div>

  <script> // type="text/typescript"

    // radius for the circle
    var RADIUS = 400

    // type: image | gif, base: string
    // interface Media {
    //   type: "image" | "gif" : string;
    //   base: string;
    //   max_frames?: number;
    //   delay_sec?: string;
    // }

    var mediaIndex = 0;
    const media = [{
      type: "gif",
      base: "ghibli-flowers",
      max_frames: 20,
      delay_sec: "0.05s"
    }, {
      type: "gif",
      base: "bird-flying",
      max_frames: 80,
      delay_sec: "0.08s"
      // }, {
      //   type: "gif",
      //   base: "cat-hiding",
      //   max_frames: 60,
      //   delay_sec: "0.08s"
    }, {
      type: "gif",
      base: "waterfall",
      max_frames: 44,
      delay_sec: "0.03s"
    }, {
      type: "image",
      filename: "niagarafalls.jpg"
    }, {
      type: "image",
      filename: "cornell.webp"
    }, {
      type: "image",
      filename: "library.webp"
    }
    ]

    const mediaVars = {
      mediaIndex: 0,
      frame: 0, // only for gifs
      updateShowingText() {
        const med = media[this.mediaIndex];
        document.getElementById("imageName").innerText = "Now showing: " + (med.type == "gif" ? med.base : med.filename);
      },
      decIndex() {
        this.mediaIndex = (this.mediaIndex + media.length - 1) % media.length;
        this.updateShowingText();
        frame = 0;
      },
      incIndex() {
        this.mediaIndex = (this.mediaIndex + 1) % media.length;
        this.updateShowingText();
        frame = 0;
      },
      getPath() {
        const med = media[this.mediaIndex];
        if (med.type == "gif") {
          this.frame = (this.frame + 1) % med.max_frames;
          if (this.frame < 10) {
            return "./" + med.base + "/frame_0" + this.frame + "_delay-" + med.delay_sec + ".gif";
          }
          return "./" + med.base + "/frame_" + this.frame + "_delay-" + med.delay_sec + ".gif";
        } else { // must be image 
          return this.imgBase + med.filename;
        }
      },
      imgBase: "./static/images/"
    }


    document.addEventListener('keydown', (e) => {
      switch (e.key) {
        case "ArrowUp":
          RADIUS += 50; break;
        case "ArrowDown":
          RADIUS -= 50; break;
        case "ArrowLeft":
          mediaVars.decIndex();
          break;
        case "ArrowRight":
          mediaVars.incIndex();
          break;
      }
    })

    // canvas, context
    var cnv = document.getElementById("mainImage");
    var cnx = cnv.getContext('2d');

    // load image
    var myimage = new Image();
    myimage.src = mediaVars.getPath();
    mediaVars.updateShowingText();


    function gray(center) {
      // calculate width/height of the viewport
      var vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0)
      var vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0)

      // set canvas to the width/height
      cnv.width = vw;
      cnv.height = vh;

      // draw the image on the viewport
      cnx.drawImage(myimage, 0, 0, vw, vh)
      var imgPixels = cnx.getImageData(0, 0, cnx.canvas.clientWidth, cnx.canvas.clientHeight)

      const HEIGHT = cnx.canvas.clientHeight;
      const WIDTH = cnx.canvas.clientWidth;

      const featherWidth = 400; // how soft the fade is

      for (var y = 0; y < HEIGHT; y++) {
        for (var x = 0; x < WIDTH; x++) {
          var dx = x - center.x;
          var dy = y - center.y;
          var dist = Math.sqrt(dx * dx + dy * dy);

          const i = (y * WIDTH + x) * 4;

          if (dist > RADIUS) {
            // how far into the fade region we are (0 â†’ 1)
            var t = (dist - RADIUS) / featherWidth;
            if (t > 1) t = 1;      // fully desaturated
            if (t < 0) t = 0;

            // grayscale value
            const r = imgPixels.data[i];
            const g = imgPixels.data[i + 1];
            const b = imgPixels.data[i + 2];
            const grayVal = (r + g + b) / 3;

            // linear blend: original * (1 - t) + grayVal * t
            imgPixels.data[i] = r * (1 - t) + grayVal * t;
            imgPixels.data[i + 1] = g * (1 - t) + grayVal * t;
            imgPixels.data[i + 2] = b * (1 - t) + grayVal * t;
          }
        }
      }


      // put new img
      cnx.putImageData(imgPixels, 0, 0, 0, 0, imgPixels.width, imgPixels.height);
    }

    myimage.onload = () => {
      gray({ x: 0, y: 0 })
    }

    var queue_maxlen = 10;
    var queue = []

    // set circle to gaze
    window.onload = function () {
      // show instructions modal
      var startModal = new bootstrap.Modal(document.getElementById("startModal"))
      startModal.show()

      // set gaze
      webgazer.setGazeListener(function (data, elapsedTime) {
        if (!data) {
          console.log("No data");
          return;
        }

        myimage = new Image();
        myimage.src = mediaVars.getPath();
        console.log(myimage) // don't remove, needs to be here for some reason
        queue.push(data)

        // if the queue is larger, remove the oldest data value
        if (queue.length > queue_maxlen) {
          queue.shift()
        }

        var avgData = {
          x: queue.reduce((acc, curr) => acc + curr.x, 0) / queue.length,
          y: queue.reduce((acc, curr) => acc + curr.y, 0) / queue.length,
        }

        gray(avgData)

        // console.log('x:', data.x, 'y:', data.y, 't:', elapsedTime);
      }).begin();
    };
  </script>

  <style>
    body {
      padding: 0;
      margin: 0;
    }

    #mainImage {
      z-index: 2;
      position: absolute;
      height: 100vh;
      width: 100vw;
    }

    #webgazerGazeDot {
      visibility: hidden !important;
    }
  </style>
  <script type="text/javascript" src="./js/typescript.min.js"></script>
  <script type="text/javascript" src="./js/typescript.compile.min.js"></script>
</body>

</html>